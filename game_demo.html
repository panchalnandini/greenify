<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoQuest Prototype — Whispering Woods</title>
<style>
  :root{
    --bg:#0b2b16;
    --ground:#12341f;
    --ui:#e6f7ec;
    --accent:#7de29a;
    --danger:#f39c12;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;}
  body{background:linear-gradient(180deg,#071710 0%, #0b2b16 100%);display:flex;align-items:center;justify-content:center;color:var(--ui);}
  #gameWrap{width:1000px;max-width:calc(100vw - 20px);aspect-ratio:16/6;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px;box-sizing:border-box;}
  /* Game canvas area */
  #viewport{background:linear-gradient(180deg,var(--ground),#0b3a21);border-radius:12px;position:relative;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.6);}
  canvas{display:block;width:100%;height:100%;border-radius:12px;}
  /* Sidebar UI */
  #uiPanel{background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:inset 0 0 40px rgba(0,0,0,0.4);}
  h1{font-size:20px;margin:0 0 6px 0;letter-spacing:0.2px;}
  .stat{font-size:14px;display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(0,0,0,0.18);border-radius:8px;}
  .btn{background:var(--accent);color:#03311a;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600;}
  .log{height:160px;overflow:auto;padding:8px;background:rgba(0,0,0,0.22);border-radius:8px;font-size:13px;}
  .controls{font-size:13px;background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;}
  /* Modal */
  .modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:360px;background:linear-gradient(180deg,#ffffff11,#00000055);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.6);backdrop-filter:blur(4px);}
  .modal h2{margin:0 0 8px 0;color:var(--ui);}
  .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
  .choice{background:rgba(255,255,255,0.06);padding:10px;border-radius:8px;cursor:pointer;border:1px solid rgba(0,0,0,0.25);}
  .choice:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.35);}
  .hidden{display:none;}
  /* HUD overlays on canvas */
  #hud{position:absolute;left:12px;top:12px;z-index:10;color:var(--ui);font-weight:600;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px;}
  #msg{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;z-index:10;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.28);}
  /* small responsive tweaks */
  @media (max-width:980px){#gameWrap{grid-template-columns:1fr;grid-template-rows:1fr 260px;aspect-ratio:16/9;}}
</style>
</head>
<body>
<div id="gameWrap">
  <div id="viewport">
    <div id="hud">Title: <span id="titleText">Guardian Seedling</span> • Leaves: <span id="leafCount">0</span></div>
    <canvas id="game"></canvas>
    <div id="msg">Move with WASD / Arrow keys. Press <strong>E</strong> to interact.</div>
    <!-- Modal placeholder -->
    <div id="modalRoot" class="hidden"></div>
  </div>

  <div id="uiPanel">
    <div>
      <h1>EcoQuest — Whispering Woods</h1>
      <div style="font-size:12px;color:#bfe9cc">Prototype: movement • interact • quiz • boss</div>
    </div>

    <div class="stat"><div>Score</div><div id="score">0</div></div>
    <div class="stat"><div>Level</div><div>Whispering Woods</div></div>

    <div class="log" id="activityLog">
      <div>Welcome, Guardian Seedling! Interact with Liora (the leaf sprite) to begin.</div>
    </div>

    <div class="controls">
      <div style="margin-bottom:8px"><strong>Controls</strong></div>
      <div>Move: <em>W A S D</em> or <em>Arrow Keys</em></div>
      <div>Interact: <em>E</em></div>
      <div>Open/Close this prototype: use sidebar actions</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:auto;">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="helpBtn">Help</button>
    </div>
  </div>
</div>

<script>
/*
  EcoQuest Prototype
  - Single-file prototype using Canvas + DOM
  - Movement, interaction, quiz, collectibles, boss trigger
*/

// --- Canvas setup ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W, H;
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  W = rect.width;
  H = rect.height;
  canvas.width = Math.floor(rect.width);
  canvas.height = Math.floor(rect.height);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// --- Game world coordinates (virtual world) ---
const world = {
  width: 2000,
  height: 1200
};

// Camera follows player
const camera = {x:0, y:0, w: W, h: H};

// --- Player ---
const player = {
  x: 300, y: 300, w: 34, h: 34,
  speed: 220, vx:0, vy:0,
  color: '#9ee9b0'
};

// --- Entities: NPCs, Items, Boss ---
const npcs = [
  {id:'liora', name:'Liora the Leaf Sprite', x:600, y:420, w:36, h:48, interactable:true}
];

const leaves = [
  {id:'leaf1', x:420, y:800, collected:false},
  {id:'leaf2', x:900, y:350, collected:false},
  {id:'leaf3', x:1400, y:720, collected:false}
];

let boss = {
  active:false,
  x:1700, y:200, w:80, h:80,
  hp:1, approaching:false
};

// --- State & UI DOM refs ---
const leafCountEl = document.getElementById('leafCount');
const scoreEl = document.getElementById('score');
const titleTextEl = document.getElementById('titleText');
const logEl = document.getElementById('activityLog');
const modalRoot = document.getElementById('modalRoot');

let score = 0;
let leafCollected = 0;
let keys = {};
let lastTime = performance.now();

// --- Input handling ---
window.addEventListener('keydown', e => {
  keys[e.key.toLowerCase()] = true;
  // interact
  if(e.key.toLowerCase() === 'e'){
    attemptInteraction();
  }
});
window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

// --- Utilities ---
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function pushLog(text){
  const d = document.createElement('div'); d.textContent = text;
  logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
}

// --- Interaction detection ---
function attemptInteraction(){
  // check NPC proximity
  for(const npc of npcs){
    const dx = npc.x - player.x;
    const dy = npc.y - player.y;
    const dist = Math.hypot(dx,dy);
    if(dist < 80){
      openQuizModal(npc);
      return;
    }
  }
  // check leaf pickup
  for(const leaf of leaves){
    if(!leaf.collected){
      const d = Math.hypot(leaf.x - player.x, leaf.y - player.y);
      if(d < 50){
        collectLeaf(leaf);
        return;
      }
    }
  }
}

// --- Collectible logic ---
function collectLeaf(leaf){
  leaf.collected = true;
  leafCollected++;
  score += 20;
  leafCountEl.textContent = leafCollected;
  scoreEl.textContent = score;
  pushLog('Collected a Knowledge Leaf! ('+leafCollected+'/3)');
  if(leafCollected >= 3 && !boss.active){
    triggerBossEncounter();
  }
}

// --- Boss encounter ---
function triggerBossEncounter(){
  boss.active = true;
  boss.approaching = true;
  pushLog('A Smog Wraith emerges... Defeat it by answering wisely!');
  showMessage('A Smog Wraith appears! Interact with it to face the challenge.');
}

// --- Modal/Quiz system ---
function openQuizModal(npc){
  // Example: NPC gives a quiz about ecosystems
  const questions = [
    {
      q: "Which of these describes a food chain correctly?",
      choices: ["Sun → Plant → Herbivore → Carnivore", "Carnivore → Plant → Sun", "Soil → Sun → Animal"],
      answer: 0,
      explain: "Energy flows from the sun to plants, then to herbivores, then to carnivores."
    },
    {
      q: "Planting diverse native species helps ecosystems because:",
      choices: ["It improves biodiversity and resilience", "It uses more water", "It attracts pests"],
      answer: 0,
      explain: "Native species support local wildlife and create balanced habitats."
    }
  ];

  // pick random question
  const q = questions[Math.floor(Math.random()*questions.length)];
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <h2>${npc.name}</h2>
    <div style="font-size:13px;margin-bottom:6px">${q.q}</div>
    <div class="choices">${q.choices.map((c,i)=>`<div class="choice" data-idx="${i}">${c}</div>`).join('')}</div>
    <div style="margin-top:8px;font-size:12px;color:#cfeed1">(Click an answer)</div>
  `;
  modalRoot.innerHTML = '';
  modalRoot.appendChild(modal);
  modalRoot.classList.remove('hidden');

  modal.querySelectorAll('.choice').forEach(el=>{
    el.addEventListener('click', ()=>{
      const idx = Number(el.dataset.idx);
      if(idx === q.answer){
        score += 10;
        scoreEl.textContent = score;
        pushLog(`${npc.name}: Correct! +10 points.`);
        showMessage('Correct! You gained knowledge.');
      } else {
        score = Math.max(0, score - 5);
        scoreEl.textContent = score;
        pushLog(`${npc.name}: Not quite... -5 points.`);
        showMessage('Not quite — try learning more from the environment.');
      }
      // close modal after short delay
      setTimeout(()=>{ modalRoot.classList.add('hidden'); modalRoot.innerHTML=''; }, 700);
      updateTitle();
    });
  });
}

// Boss interaction
function openBossModal(){
  const q = {
    q: "How do you reduce single-use plastic pollution most directly?",
    choices: [
      "Reuse containers & switch to reusable bags",
      "Use more different types of plastics",
      "Burn the plastic safely"
    ],
    answer: 0,
    explain: "Reusing reduces demand for single-use items and waste."
  };
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <h2>Smog Wraith — Challenge</h2>
    <div style="font-size:13px;margin-bottom:6px">${q.q}</div>
    <div class="choices">${q.choices.map((c,i)=>`<div class="choice" data-idx="${i}">${c}</div>`).join('')}</div>
    <div style="margin-top:8px;font-size:12px;color:#ffcfa1">(Choose the best eco-action)</div>
  `;
  modalRoot.innerHTML = '';
  modalRoot.appendChild(modal);
  modalRoot.classList.remove('hidden');

  modal.querySelectorAll('.choice').forEach(el=>{
    el.addEventListener('click', ()=>{
      const idx = Number(el.dataset.idx);
      if(idx === q.answer){
        boss.hp = 0;
        pushLog('Smog Wraith defeated! The woods breathe again.');
        score += 100;
        scoreEl.textContent = score;
        showMessage('You defeated the Smog Wraith! Gaia restores a little.');
        endGameVictory();
      } else {
        pushLog('The Smog Wraith grows stronger... Try again or collect more knowledge.');
        showMessage('Wrong choice — the smog persists.');
      }
      setTimeout(()=>{ modalRoot.classList.add('hidden'); modalRoot.innerHTML=''; }, 700);
      updateTitle();
    });
  });
}

// --- HUD and titles based on score/leaf count ---
function updateTitle(){
  if(score >= 200) titleTextEl.textContent = 'Master of Earth';
  else if(score >= 100) titleTextEl.textContent = 'Planet Protector';
  else if(score >= 50) titleTextEl.textContent = 'Green Guardian';
  else titleTextEl.textContent = 'Guardian Seedling';
}

// --- Simple message overlay ---
const msgEl = document.getElementById('msg');
let msgTimeout = null;
function showMessage(text, duration=3000){
  msgEl.textContent = text;
  msgEl.style.opacity = '1';
  if(msgTimeout) clearTimeout(msgTimeout);
  msgTimeout = setTimeout(()=>{ msgEl.style.opacity = '0.9'; }, duration);
}

// --- Game loop ---
function update(dt){
  // movement input
  let mx = 0, my = 0;
  if(keys['arrowup'] || keys['w']) my -= 1;
  if(keys['arrowdown'] || keys['s']) my += 1;
  if(keys['arrowleft'] || keys['a']) mx -= 1;
  if(keys['arrowright'] || keys['d']) mx += 1;
  const len = Math.hypot(mx,my) || 1;
  player.vx = (mx/len) * player.speed;
  player.vy = (my/len) * player.speed;
  // apply movement
  player.x += player.vx * dt;
  player.y += player.vy * dt;
  // clamp within world
  player.x = clamp(player.x, 30, world.width-30);
  player.y = clamp(player.y, 30, world.height-30);

  // camera centers on player
  camera.x = clamp(player.x - W/2, 0, world.width - W);
  camera.y = clamp(player.y - H/2, 0, world.height - H);

  // boss behavior: slowly move towards player if active & not defeated
  if(boss.active && boss.hp > 0){
    if(boss.approaching){
      const dx = player.x - boss.x;
      const dy = player.y - boss.y;
      const d = Math.hypot(dx,dy);
      if(d > 40){
        // healer step
        boss.x += (dx/d) * 40 * dt;
        boss.y += (dy/d) * 40 * dt;
      }
    }
    // if player close, allow interaction (E)
    const dClose = Math.hypot(boss.x - player.x, boss.y - player.y);
    if(dClose < 90){
      // hint to interact
      showMessage('Press E to challenge the Smog Wraith!');
    }
  }
}

function render(){
  // clear
  ctx.clearRect(0,0,W,H);

  // draw background subtle grid / trees
  // background ground
  ctx.fillStyle = '#0e3a21';
  ctx.fillRect(0,0,W,H);

  // draw decorative trees (tile-like) in world coordinates
  for(let gx=0; gx<world.width; gx+=160){
    for(let gy=0; gy<world.height; gy+=180){
      const screenX = Math.floor(gx - camera.x);
      const screenY = Math.floor(gy - camera.y);
      // skip draws out of view
      if(screenX < -80 || screenX > W+80 || screenY < -80 || screenY > H+80) continue;
      // trunk
      ctx.fillStyle = '#2a1c0f';
      ctx.fillRect(screenX+12, screenY+40, 10, 20);
      // leaves
      ctx.beginPath();
      ctx.fillStyle = '#1f8f4d';
      ctx.ellipse(screenX+17, screenY+28, 26, 28, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.closePath();
    }
  }

  // draw leaves (collectibles)
  for(const leaf of leaves){
    const sx = Math.floor(leaf.x - camera.x);
    const sy = Math.floor(leaf.y - camera.y);
    if(leaf.collected) continue;
    // leaf shape
    ctx.save();
    ctx.translate(sx, sy);
    ctx.rotate(Math.sin((performance.now()+leaf.x)*0.002)*0.12);
    ctx.beginPath();
    ctx.fillStyle = '#7de29a';
    ctx.ellipse(0,0,14,10, Math.PI/6, 0, Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // stem
    ctx.strokeStyle = '#2a8a58';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(6,2);
    ctx.lineTo(12,8);
    ctx.stroke();
    ctx.restore();
  }

  // draw NPCs
  for(const npc of npcs){
    const sx = Math.floor(npc.x - camera.x);
    const sy = Math.floor(npc.y - camera.y);
    // simple sprite: floating leaf sprite
    ctx.save();
    const bob = Math.sin((performance.now()+npc.x)*0.002)*6;
    ctx.translate(sx, sy + bob);
    // body
    ctx.fillStyle = '#a6f5c4';
    ctx.beginPath();
    ctx.ellipse(0, -6, 16, 22, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // eyes
    ctx.fillStyle = '#05321a';
    ctx.fillRect(-6, -12, 4, 4);
    ctx.fillRect(4, -12, 4, 4);
    ctx.restore();
  }

  // draw boss if active
  if(boss.active && boss.hp > 0){
    const sx = Math.floor(boss.x - camera.x);
    const sy = Math.floor(boss.y - camera.y);
    // smoky orb
    const t = performance.now()*0.002;
    const radius = 36 + Math.sin(t)*6;
    let grad = ctx.createRadialGradient(sx,sy,8,sx,sy,radius+12);
    grad.addColorStop(0,'rgba(120,120,120,0.9)');
    grad.addColorStop(0.6,'rgba(80,80,80,0.6)');
    grad.addColorStop(1,'rgba(40,40,40,0.14)');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(sx,sy,radius,0,Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // eyes
    ctx.fillStyle = '#fde1a8';
    ctx.fillRect(sx-10, sy-6, 8, 8);
    ctx.fillRect(sx+2, sy-6, 8, 8);
  }

  // draw player (simple circle avatar)
  const px = Math.floor(player.x - camera.x);
  const py = Math.floor(player.y - camera.y);
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(px, py, 18, 0, Math.PI*2);
  ctx.fill();
  ctx.closePath();
  // player 'leaf halo'
  ctx.strokeStyle = 'rgba(125,226,154,0.45)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(px, py, 26, 0, Math.PI*2);
  ctx.stroke();
  ctx.closePath();
}

// --- End game / victory ---
function endGameVictory(){
  pushLog('Congratulations — You restored part of Gaia! Prototype complete.');
  showMessage('Victory! Gaia thanks you ✨', 7000);
  // simple celebration: spawn floating leaves
  for(let i=0;i<12;i++){
    setTimeout(()=>{ pushLog('Leaf sparkles ✨'); }, 200*i);
  }
}

// --- Main loop runner ---
function loop(now){
  const dt = Math.min(0.05, (now - lastTime)/1000);
  update(dt);
  render();
  lastTime = now;
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// --- Interaction with boss when pressing E near boss ---
function checkBossInteraction(){
  if(!boss.active || boss.hp <= 0) return;
  const d = Math.hypot(boss.x - player.x, boss.y - player.y);
  if(d < 90){
    openBossModal();
  }
}

// replace attemptInteraction's boss check
function attemptInteraction(){
  // check boss first if active
  if(boss.active && boss.hp > 0){
    const d = Math.hypot(boss.x - player.x, boss.y - player.y);
    if(d < 90){ checkBossInteraction(); return; }
  }
  // check NPC proximity
  for(const npc of npcs){
    const dx = npc.x - player.x;
    const dy = npc.y - player.y;
    const dist = Math.hypot(dx,dy);
    if(dist < 80){
      openQuizModal(npc);
      return;
    }
  }
  // check leaf pickup
  for(const leaf of leaves){
    if(!leaf.collected){
      const d = Math.hypot(leaf.x - player.x, leaf.y - player.y);
      if(d < 50){
        collectLeaf(leaf);
        return;
      }
    }
  }
  pushLog("There's nothing to interact with here.");
}

// --- Buttons ---
document.getElementById('resetBtn').addEventListener('click', ()=>{
  location.reload();
});
document.getElementById('helpBtn').addEventListener('click', ()=>{
  alert("This is a prototype. Move with WASD / Arrows. Press E to interact with Liora, collect leaves, and challenge the Smog Wraith.");
});

// small heartbeat to update title occasionally
setInterval(updateTitle, 600);

// ensure modal closes if user clicks outside (simple)
document.addEventListener('click', (ev)=>{
  if(modalRoot.classList.contains('hidden')) return;
  // if click outside modal area, close
  const m = modalRoot.firstElementChild;
  if(m && !m.contains(ev.target)) { modalRoot.classList.add('hidden'); modalRoot.innerHTML=''; }
});

// initial camera update
camera.x = player.x - W/2; camera.y = player.y - H/2;
</script>
</body>
</html>
